<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAR - Shaigan's Learning Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1e1e2f, #2a2a4e);
            color: #fff;
            overflow-x: hidden;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn:hover {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ce79);
            background-size: 400%;
            animation: rainbow 8s linear infinite;
            transform: translateY(-2px);
        }
        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 400% 50%; }
            100% { background-position: 0% 50%; }
        }
        #loginPage, #registerPage, #libraryPage, #bookSummaryPage, #quizPage, #scoreCardPage {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        #loginPage.active, #registerPage.active, #libraryPage.active, #bookSummaryPage.active, #quizPage.active, #scoreCardPage.active {
            display: block;
        }
        .form-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            text-align: center;
        }
        .form-container input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .library-container {
            max-width: 1200px;
            margin: 50px auto;
        }
        .search-bar {
            margin-bottom: 20px;
            padding: 10px;
            width: 100%;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        .bookshelf {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }
        .book {
            text-align: center;
            transition: transform 0.3s ease;
        }
        .book img {
            width: 100%;
            border-radius: 10px;
            cursor: pointer;
        }
        .book:hover {
            transform: scale(1.05);
        }
        .slide-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            position: relative;
        }
        .slide {
            display: none;
            animation: fadeIn 0.5s;
        }
        .slide.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .navigation {
            margin-top: 20px;
            text-align: center;
        }
        .quiz-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .quiz-option {
            display: block;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            cursor: pointer;
        }
        .quiz-option:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .score-card {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            text-align: center;
        }
        .certificate {
            border: 10px solid transparent;
            border-image: url('https://i.imgur.com/5zKXz0B.png') 30 round;
            padding: 20px;
        }
        .stopwatch {
            position: fixed;
            top: 20px;
            right: 20px;
            font-size: 18px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div id="loginPage" class="active">
        <div class="form-container glass">
            <h2>STAR LMS - Login</h2>
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Password" required>
            <button class="btn" onclick="login()">Login</button>
        </div>
    </div>
    <div id="registerPage">
        <div class="form-container glass">
            <h2>Register</h2>
            <input type="text" id="fullName" placeholder="Full Name" required>
            <input type="text" id="designation" placeholder="Designation" required>
            <input type="text" id="team" placeholder="Team/Department" required>
            <input type="text" id="city" placeholder="Base City" required>
            <input type="date" id="date" required>
            <input type="email" id="email" placeholder="Email" required>
            <input type="tel" id="cell" placeholder="Cell Number" required>
            <button class="btn" onclick="register()">Register</button>
        </div>
    </div>
    <div id="libraryPage">
        <div class="library-container glass">
            <h2>STAR Library</h2>
            <input type="text" class="search-bar" id="searchBar" placeholder="Search Books..." onkeyup="searchBooks()">
            <div id="bookshelves"></div>
        </div>
    </div>
    <div id="bookSummaryPage">
        <div class="slide-container glass">
            <div class="stopwatch" id="summaryStopwatch">00:00</div>
            <div id="slides"></div>
            <div class="navigation">
                <button class="btn" onclick="navigateSlide('first')">First</button>
                <button class="btn" onclick="navigateSlide('prev')">Back</button>
                <button class="btn" onclick="navigateSlide('next')">Next</button>
                <button class="btn" onclick="navigateSlide('last')">Last</button>
                <button class="btn" onclick="goToHome()">Home</button>
                <button class="btn" id="quizButton" style="display: none;" onclick="startQuiz()">Let's Check Your Understanding</button>
            </div>
        </div>
    </div>
    <div id="quizPage">
        <div class="quiz-container glass">
            <div class="stopwatch" id="quizStopwatch">00:00</div>
            <h2 id="quizQuestion"></h2>
            <div id="quizOptions"></div>
            <div class="navigation">
                <button class="btn" onclick="submitAnswer()">Submit</button>
            </div>
        </div>
    </div>
    <div id="scoreCardPage">
        <div class="score-card glass certificate">
            <h2>STAR LMS - Score Card</h2>
            <div id="scoreDetails"></div>
            <div class="navigation">
                <button class="btn" onclick="downloadPDF()">Download PDF</button>
                <button class="btn" onclick="checkAnswers()">Check Answers</button>
                <button class="btn" onclick="goToHome()">Home</button>
            </div>
        </div>
    </div>

    <script>
        let userData = null;
        let currentBook = null;
        let currentSlide = 0;
        let currentQuestion = 0;
        let quizAnswers = [];
        let summaryTime = 0;
        let quizTime = 0;
        let stopwatchInterval;
        const books = [];
        const bookFiles = ['1books.json', '2books.json', '3books.json', '4books.json', '5books.json', '6books.json', '7books.json', '8books.json', '9books.json', '10books.json'];

        // Fallback book data in case JSON files fail
        const fallbackBooks = [
            {
                section: "Programming",
                title: "Introduction to JavaScript",
                thumbnail: "https://via.placeholder.com/150",
                slides: [
                    { title: "Slide 1", content: "JavaScript is a versatile programming language used for web development." },
                    { title: "Slide 2", content: "Variables are declared using var, let, or const." }
                    // Add more slides as needed
                ],
                quiz: [
                    {
                        question: "What is JavaScript?",
                        options: ["A programming language", "A styling language", "A database", "A markup language"],
                        correct: 0
                    }
                    // Add more questions as needed
                ]
            }
        ];

        function startStopwatch(elementId) {
            console.log('Starting stopwatch for:', elementId);
            let seconds = 0;
            stopwatchInterval = setInterval(() => {
                seconds++;
                const minutes = Math.floor(seconds / 60);
                const secs = seconds % 60;
                document.getElementById(elementId).textContent = `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (elementId === 'summaryStopwatch') summaryTime = seconds;
                else quizTime = seconds;
            }, 1000);
        }

        function stopStopwatch() {
            console.log('Stopping stopwatch');
            clearInterval(stopwatchInterval);
        }

        function login() {
            console.log('Login button clicked');
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            console.log('Email:', email, 'Password:', password);
            if (email && password) {
                fetchUserData(email);
            } else {
                alert('Please enter both email and password.');
            }
        }

        function fetchUserData(email) {
            console.log('Fetching user data for:', email);
            try {
                userData = JSON.parse(localStorage.getItem(email));
                console.log('User data:', userData);
                if (userData) {
                    console.log('User found, going to library');
                    showPage('libraryPage');
                    loadBooks();
                } else {
                    console.log('No user found, going to register');
                    showPage('registerPage');
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
                alert('Error accessing user data. Please try again.');
            }
        }

        function register() {
            console.log('Register button clicked');
            userData = {
                fullName: document.getElementById('fullName').value,
                designation: document.getElementById('designation').value,
                team: document.getElementById('team').value,
                city: document.getElementById('city').value,
                date: document.getElementById('date').value,
                email: document.getElementById('email').value,
                cell: document.getElementById('cell').value,
                scores: []
            };
            try {
                localStorage.setItem(userData.email, JSON.stringify(userData));
                console.log('User registered:', userData);
                showPage('libraryPage');
                loadBooks();
            } catch (error) {
                console.error('Error saving user data:', error);
                alert('Error saving registration. Please try again.');
            }
        }

        function saveToGoogleSheets(data) {
            console.log('Saving to Google Sheets:', data);
            // Placeholder for Google Sheets API
        }

        function showPage(pageId) {
            console.log('Showing page:', pageId);
            try {
                document.querySelectorAll('#loginPage, #registerPage, #libraryPage, #bookSummaryPage, #quizPage, #scoreCardPage').forEach(page => {
                    page.classList.remove('active');
                });
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    console.error('Page not found:', pageId);
                    alert('Page not found. Please check the console.');
                }
            } catch (error) {
                console.error('Error showing page:', error);
                alert('Error navigating to page. Please check the console.');
            }
        }

        function loadBooks() {
            console.log('Loading books');
            const bookshelves = document.getElementById('bookshelves');
            bookshelves.innerHTML = '<p>Loading books...</p>';
            let loadedFiles = 0;
            if (bookFiles.length === 0) {
                books.push(...fallbackBooks);
                displayBooks();
                return;
            }
            bookFiles.forEach(file => {
                fetch(file)
                    .then(response => {
                        if (!response.ok) throw new Error(`Failed to load ${file}`);
                        return response.json();
                    })
                    .then(data => {
                        books.push(...data);
                        loadedFiles++;
                        if (loadedFiles === bookFiles.length) {
                            if (books.length === 0) {
                                books.push(...fallbackBooks);
                            }
                            displayBooks();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading books:', error);
                        loadedFiles++;
                        if (loadedFiles === bookFiles.length) {
                            if (books.length === 0) {
                                books.push(...fallbackBooks);
                                bookshelves.innerHTML = '<p>Using fallback books due to loading issues.</p>';
                            }
                            displayBooks();
                        }
                    });
            });
        }

        function displayBooks() {
            console.log('Displaying books');
            const bookshelves = document.getElementById('bookshelves');
            bookshelves.innerHTML = '';
            if (books.length === 0) {
                bookshelves.innerHTML = '<p>No books available.</p>';
                return;
            }
            const sections = [...new Set(books.map(book => book.section))];
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `<h3>${section}</h3>`;
                const shelf = document.createElement('div');
                shelf.className = 'bookshelf';
                books.filter(book => book.section === section).forEach(book => {
                    const bookDiv = document.createElement('div');
                    bookDiv.className = 'book';
                    bookDiv.innerHTML = `<img src="${book.thumbnail}" alt="${book.title}"><p>${book.title}</p>`;
                    bookDiv.onclick = () => showBookSummary(book);
                    shelf.appendChild(bookDiv);
                });
                sectionDiv.appendChild(shelf);
                bookshelves.appendChild(sectionDiv);
            });
        }

        function searchBooks() {
            const query = document.getElementById('searchBar').value.toLowerCase();
            console.log('Searching books:', query);
            const bookshelves = document.getElementById('bookshelves');
            bookshelves.innerHTML = '';
            const filteredBooks = books.filter(book => book.title.toLowerCase().includes(query));
            if (filteredBooks.length === 0) {
                bookshelves.innerHTML = '<p>No books found.</p>';
                return;
            }
            const sections = [...new Set(filteredBooks.map(book => book.section))];
            sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.innerHTML = `<h3>${section}</h3>`;
                const shelf = document.createElement('div');
                shelf.className = 'bookshelf';
                filteredBooks.filter(book => book.section === section).forEach(book => {
                    const bookDiv = document.createElement('div');
                    bookDiv.className = 'book';
                    bookDiv.innerHTML = `<img src="${book.thumbnail}" alt="${book.title}"><p>${book.title}</p>`;
                    bookDiv.onclick = () => showBookSummary(book);
                    shelf.appendChild(bookDiv);
                });
                sectionDiv.appendChild(shelf);
                bookshelves.appendChild(sectionDiv);
            });
        }

        function showBookSummary(book) {
            console.log('Showing book summary:', book.title);
            currentBook = book;
            currentSlide = 0;
            showPage('bookSummaryPage');
            displaySlide();
            startStopwatch('summaryStopwatch');
        }

        function displaySlide() {
            console.log('Displaying slide:', currentSlide);
            const slidesDiv = document.getElementById('slides');
            slidesDiv.innerHTML = '';
            const slide = document.createElement('div');
            slide.className = 'slide active';
            slide.innerHTML = `<h3>${currentBook.slides[currentSlide].title}</h3><p>${currentBook.slides[currentSlide].content}</p>`;
            slidesDiv.appendChild(slide);
            document.getElementById('quizButton').style.display = currentSlide === currentBook.slides.length - 1 ? 'inline-block' : 'none';
        }

        function navigateSlide(direction) {
            console.log('Navigating slide:', direction);
            if (direction === 'first') currentSlide = 0;
            else if (direction === 'prev' && currentSlide > 0) currentSlide--;
            else if (direction === 'next' && currentSlide < currentBook.slides.length - 1) currentSlide++;
            else if (direction === 'last') currentSlide = currentBook.slides.length - 1;
            displaySlide();
        }

        function goToHome() {
            console.log('Returning to home');
            stopStopwatch();
            showPage('libraryPage');
        }

        function startQuiz() {
            console.log('Starting quiz');
            stopStopwatch();
            currentQuestion = 0;
            quizAnswers = [];
            showPage('quizPage');
            displayQuestion();
            startStopwatch('quizStopwatch');
        }

        function displayQuestion() {
            console.log('Displaying question:', currentQuestion);
            const question = currentBook.quiz[currentQuestion];
            document.getElementById('quizQuestion').textContent = question.question;
            const optionsDiv = document.getElementById('quizOptions');
            optionsDiv.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                optionDiv.onclick = () => selectOption(index);
                optionsDiv.appendChild(optionDiv);
            });
        }

        function selectOption(index) {
            console.log('Selected option:', index);
            quizAnswers[currentQuestion] = index;
            if (currentQuestion < currentBook.quiz.length - 1) {
                currentQuestion++;
                displayQuestion();
            } else {
                stopStopwatch();
                showScoreCard();
            }
        }

        function submitAnswer() {
            console.log('Submitting answer for question:', currentQuestion);
            if (quizAnswers[currentQuestion] !== undefined) {
                selectOption(quizAnswers[currentQuestion]);
            } else {
                alert('Please select an option before submitting.');
            }
        }

        function showScoreCard() {
            console.log('Showing score card');
            showPage('scoreCardPage');
            let score = 0;
            currentBook.quiz.forEach((q, i) => {
                if (quizAnswers[i] === q.correct) score += 5;
            });
            let grade = '';
            let encouragement = '';
            if (score === 100) {
                grade = 'A1';
                encouragement = "Outstanding! You have mastered this book!";
            } else if (score >= 90) {
                grade = 'A';
                encouragement = "Excellent work! You are almost at the top!";
            } else if (score >= 75) {
                grade = 'B';
                encouragement = "Great job! Keep pushing forward!";
            } else if (score >= 60) {
                grade = 'C';
                encouragement = "Good effort! A bit more study will get you there!";
            } else if (score >= 40) {
                grade = 'D';
                encouragement = "You are on the right track! Keep practicing!";
            } else {
                grade = 'E';
                encouragement = "Do not give up! Review and try again!";
            }
            userData.scores.push({
                book: currentBook.title,
                score,
                grade,
                summaryTime,
                quizTime
            });
            try {
                localStorage.setItem(userData.email, JSON.stringify(userData));
                saveToGoogleSheets(userData);
            } catch (error) {
                console.error('Error saving score:', error);
            }
            document.getElementById('scoreDetails').innerHTML = `
                <p>Name: ${userData.fullName}</p>
                <p>Email: ${userData.email}</p>
                <p>Book: ${currentBook.title}</p>
                <p>Score: ${score}/100</p>
                <p>Grade: ${grade}</p>
                <p>Summary Time: ${Math.floor(summaryTime / 60)}:${(summaryTime % 60).toString().padStart(2, '0')}</p>
                <p>Quiz Time: ${Math.floor(quizTime / 60)}:${(quizTime % 60).toString().padStart(2, '0')}</p>
                <p>${encouragement}</p>
            `;
        }

        function checkAnswers() {
            console.log('Checking answers');
            const answersDiv = document.createElement('div');
            currentBook.quiz.forEach((q, i) => {
                const correct = q.correct === quizAnswers[i];
                answersDiv.innerHTML += `<p>Question ${i + 1}: ${q.question}<br>
                    Your Answer: ${q.options[quizAnswers[i]] || 'Not answered'}<br>
                    Correct Answer: ${q.options[q.correct]}<br>
                    ${correct ? 'Correct' : 'Incorrect'}</p>`;
            });
            document.getElementById('scoreDetails').appendChild(answersDiv);
        }

        function downloadPDF() {
            console.log('Downloading PDF');
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(20);
                doc.text('STAR LMS Certificate', 105, 20, { align: 'center' });
                doc.setFontSize(12);
                doc.text(`Name: ${userData.fullName}`, 20, 40);
                doc.text(`Email: ${userData.email}`, 20, 50);
                doc.text(`Book: ${currentBook.title}`, 20, 60);
                doc.text(`Score: ${userData.scores[userData.scores.length - 1].score}/100`, 20, 70);
                doc.text(`Grade: ${userData.scores[userData.scores.length - 1].grade}`, 20, 80);
                doc.text(`Summary Time: ${Math.floor(summaryTime / 60)}:${(summaryTime % 60).toString().padStart(2, '0')}`, 20, 90);
                doc.text(`Quiz Time: ${Math.floor(quizTime / 60)}:${(quizTime % 60).toString().padStart(2, '0')}`, 20, 100);
                doc.save('STAR_Certificate.pdf');
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please check the console.');
            }
        }
    </script>
</body>
</html>
